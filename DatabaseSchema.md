# Database Schema - CurlingDrawWeightPractice

This document outlines the detailed database schema for the CurlingDrawWeightPractice application. The database is designed to support a microservices architecture using Google Cloud services, primarily Cloud Firestore for NoSQL data storage.

## 1. Data Model Overview

The schema follows a document-based NoSQL approach to allow for horizontal scaling and flexibility. The primary collections are:

- `users` - User accounts and profiles
- `shotTypes` - Predefined shot type definitions
- `practiceSessions` - Practice session metadata
- `shotResults` - Individual shot measurements and results
- `statistics` - Aggregated performance metrics
- `settings` - Application configuration parameters
- `translations` - Multilingual text resources

## 2. Collection Structures

### 2.1. Users Collection

**Collection: `users`**

Document ID: User ID (generated by Firebase Authentication)

```json
{
  "userId": "string",
  "email": "string",
  "displayName": "string",
  "createdAt": "timestamp",
  "lastLoginAt": "timestamp",
  "preferences": {
    "language": "string",
    "theme": "string",
    "notifications": "boolean",
    "unitSystem": "string" 
  },
  "statistics": {
    "totalPracticeSessions": "number",
    "totalShots": "number",
    "averageAccuracy": "number",
    "lastPracticeDate": "timestamp"
  },
  "teams": [
    {
      "teamId": "string",
      "role": "string",
      "joinedAt": "timestamp"
    }
  ]
}
```

### 2.2. Shot Types Collection

**Collection: `shotTypes`**

Document ID: Shot Type ID (e.g., "VK", "VL", etc.)

```json
{
  "shotTypeId": "string",
  "name": {
    "en": "string",
    "fi": "string"
  },
  "description": {
    "en": "string",
    "fi": "string"
  },
  "targetPosition": {
    "x": "number",
    "y": "number"
  },
  "rotation": "string",
  "rotationPairing": "string",
  "difficulty": "number",
  "order": "number",
  "isActive": "boolean",
  "category": "string"
}
```

*Notes:*
- `rotation` will be fixed as "MP" for right-side shots, "VP" for left-side shots, and null for center line shots
- `rotationPairing` for center shots will be one of: "T_PV" or "ES_TS" to identify rotation pairs

### 2.3. Practice Sessions Collection

**Collection: `practiceSessions`**

Document ID: Auto-generated

```json
{
  "sessionId": "string",
  "userId": "string",
  "startTime": "timestamp",
  "endTime": "timestamp",
  "isCompleted": "boolean",
  "notes": "string",
  "shotCount": "number",
  "completedShotCount": "number",
  "overallAccuracy": "number",
  "centerLineRotationType": "string",
  "sessionType": "string",
  "selectedShotTypes": ["string"],
  "deviceInfo": {
    "deviceType": "string",
    "operatingSystem": "string",
    "appVersion": "string"
  },
  "shotTypeResults": {
    "VK": { "accuracy": "number", "rotation": "string" },
    "VL": { "accuracy": "number", "rotation": "string" },
    "VT": { "accuracy": "number", "rotation": "string" },
    "OK": { "accuracy": "number", "rotation": "string" },
    "OL": { "accuracy": "number", "rotation": "string" },
    "OT": { "accuracy": "number", "rotation": "string" },
    "PV": { "accuracy": "number", "rotation": "string" },
    "ES": { "accuracy": "number", "rotation": "string" },
    "T": { "accuracy": "number", "rotation": "string" },
    "TS": { "accuracy": "number", "rotation": "string" }
  }
}
```

*Notes:*
- `centerLineRotationType` will be either "T_PV_MP" or "T_PV_VP"
- `sessionType` can be "standard" or "custom"
- `shotTypeResults` contains a summary of performance for each shot type in the session

### 2.4. Shot Results Collection

**Collection: `shotResults`**

Document ID: Auto-generated

```json
{
  "shotResultId": "string",
  "sessionId": "string",
  "userId": "string",
  "shotTypeId": "string",
  "sequenceNumber": "number",
  "distanceCm": "number",
  "directionDegrees": "number",
  "rotation": "string",
  "accuracy": "number",
  "timestamp": "timestamp",
  "notes": "string",
  "videoUrl": "string",
  "videoThumbnailUrl": "string"
}
```

*Notes:*
- This collection will grow rapidly as users record shots
- Consider implementing TTL (Time To Live) for older data or automatic archiving

### 2.5. Statistics Collection

**Collection: `statistics`**

Document ID: UserID_StatType_TimeFrame

```json
{
  "userId": "string",
  "statisticType": "string",
  "timeFrame": "string", 
  "calculatedAt": "timestamp",
  "shotTypeData": {
    "VK": {
      "count": "number",
      "sumAccuracy": "number",
      "averageAccuracy": "number",
      "bestResult": "number",
      "worstResult": "number",
      "trend": "number"
    },
    // Similar for all shot types
  },
  "rotationData": {
    "MP": {
      "count": "number",
      "averageAccuracy": "number"
    },
    "VP": {
      "count": "number",
      "averageAccuracy": "number"
    }
  },
  "overallStats": {
    "totalShots": "number",
    "averageAccuracy": "number",
    "bestShotType": "string",
    "worstShotType": "string",
    "sessionsCompleted": "number"
  }
}
```

*Notes:*
- `statisticType` can be "shotType", "rotation", "trend", etc.
- `timeFrame` can be "all", "lastMonth", "lastWeek", etc.
- Statistics are pre-calculated to avoid expensive on-demand aggregation

### 2.6. Settings Collection

**Collection: `settings`**

Document ID: SettingType

```json
{
  "settingId": "string",
  "name": "string",
  "description": "string",
  "value": "any",
  "category": "string",
  "isPublic": "boolean",
  "lastUpdated": "timestamp",
  "updatedBy": "string"
}
```

*Notes:*
- Used for application-wide settings
- Examples include accuracy calculation parameters, rotation rules, etc.

### 2.7. Translations Collection

**Collection: `translations`**

Document ID: LanguageCode_Category

```json
{
  "languageCode": "string",
  "category": "string",
  "items": {
    "key1": "string",
    "key2": "string",
    // Additional key-value pairs
  },
  "lastUpdated": "timestamp"
}
```

*Notes:*
- Category examples: "ui", "shots", "help", etc.
- This allows for efficient retrieval of translations by language and category

## 3. Indexes and Query Patterns

### 3.1. Primary Indexes

1. **Practice Sessions**
   - By `userId` and `startTime` (descending) - For listing user's sessions
   - By `userId` and `isCompleted` - For finding incomplete sessions to resume

2. **Shot Results**
   - By `sessionId` and `sequenceNumber` - For ordering shots within a session
   - By `userId` and `shotTypeId` - For analyzing performance by shot type
   - By `userId` and `timestamp` - For chronological analysis

3. **Statistics**
   - By `userId` and `timeFrame` - For retrieving user statistics for specific periods

### 3.2. Common Query Patterns

1. **Retrieving User's Session History**
```
GET practiceSessions
WHERE userId = {userId}
ORDER BY startTime DESC
LIMIT 10
```

2. **Retrieving Individual Shot Results for a Session**
```
GET shotResults
WHERE sessionId = {sessionId}
ORDER BY sequenceNumber ASC
```

3. **Retrieving Performance Trend for a Shot Type**
```
GET statistics
WHERE userId = {userId}
AND statisticType = "shotType"
AND timeFrame IN ["lastWeek", "lastMonth", "all"]
```

4. **Finding Incomplete Sessions**
```
GET practiceSessions
WHERE userId = {userId}
AND isCompleted = false
ORDER BY startTime DESC
LIMIT 1
```

## 4. Microservice Data Boundaries

Based on the microservices architecture outlined in the project plan, the data access will be organized as follows:

### 4.1. User Service
- Primary collections: `users`
- Read access to: `statistics` (for profile data)

### 4.2. Training Service
- Primary collections: `practiceSessions`, `shotTypes`
- Read/write access to: `shotResults`

### 4.3. Metrics Service
- Primary collections: `statistics`
- Read access to: `shotResults`, `practiceSessions`
- Handles calculation and storage of performance metrics

### 4.4. Notification Service
- Read access to: `users` (for preferences), `statistics` (for triggers)

### 4.5. Analytics Service
- Read access to: `shotResults`, `practiceSessions`, `statistics`
- Generates insights and recommendations

### 4.6. Content Service
- Primary collections: `translations`, `settings`
- Manages localization and application configuration

## 5. Data Migration Strategy

### 5.1. Schema Versioning
- Each document will include a `schemaVersion` field
- Migration scripts will run as background processes
- Version compatibility will be maintained for at least one previous version

### 5.2. Data Backups
- Daily automated backups of all collections
- Point-in-time recovery capability
- Backup retention policy: 30 days for daily backups, 1 year for monthly backups

## 6. Security Rules

### 6.1. Firestore Security Rules

```
service cloud.firestore {
  match /databases/{database}/documents {
    // User can only access their own profile
    match /users/{userId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
    }
    
    // Shot types are readable by all authenticated users
    match /shotTypes/{shotTypeId} {
      allow read: if request.auth != null;
      allow write: if false; // Admin-only via backend
    }
    
    // Users can only access their own practice sessions
    match /practiceSessions/{sessionId} {
      allow read, write: if request.auth != null && 
                          request.auth.uid == resource.data.userId;
    }
    
    // Users can only access their own shot results
    match /shotResults/{shotResultId} {
      allow read, write: if request.auth != null && 
                          request.auth.uid == resource.data.userId;
    }
    
    // Statistics accessible only by the user
    match /statistics/{statId} {
      allow read: if request.auth != null && 
                   resource.data.userId == request.auth.uid;
      allow write: if false; // System-generated only
    }
    
    // Settings and translations are readable by all users
    match /settings/{settingId} {
      allow read: if request.auth != null && resource.data.isPublic == true;
      allow write: if false; // Admin-only
    }
    
    match /translations/{translationId} {
      allow read: if request.auth != null;
      allow write: if false; // Admin-only
    }
  }
}
```

## 7. Initialization Data

The following data will be pre-populated in the database at application launch:

### 7.1. Shot Types

Shot types will be initialized with the 10 standard shot types described in the requirements:

1. **VK (Left side long guard)**
   - Target Position: X=-150, Y=100
   - Rotation: "VP"
   - Difficulty: 3

2. **VL (Left side short guard)**
   - Target Position: X=-150, Y=300
   - Rotation: "VP"
   - Difficulty: 3

3. **VT (Left side tee line shot)**
   - Target Position: X=-213, Y=427
   - Rotation: "VP"
   - Difficulty: 2

4. **OK (Right side long guard)**
   - Target Position: X=150, Y=100
   - Rotation: "MP"
   - Difficulty: 3

5. **OL (Right side short guard)**
   - Target Position: X=150, Y=300
   - Rotation: "MP"
   - Difficulty: 3

6. **OT (Right side tee line shot)**
   - Target Position: X=213, Y=427
   - Rotation: "MP"
   - Difficulty: 2

7. **PV (Center line half-way guard)**
   - Target Position: X=0, Y=200
   - RotationPairing: "T_PV"
   - Difficulty: 3

8. **ES (Center line draw to 8-foot)**
   - Target Position: X=0, Y=350
   - RotationPairing: "ES_TS"
   - Difficulty: 2

9. **T (Button)**
   - Target Position: X=0, Y=427
   - RotationPairing: "T_PV"
   - Difficulty: 1

10. **TS (Back 8-foot)**
    - Target Position: X=0, Y=500
    - RotationPairing: "ES_TS"
    - Difficulty: 4

### 7.2. Initial Settings

```json
[
  {
    "settingId": "accuracy_calculation",
    "value": {
      "distanceWeight": 0.7,
      "directionWeight": 0.3,
      "perfectDistance": 0,
      "worstDistance": 200
    },
    "isPublic": true
  },
  {
    "settingId": "rotation_rules",
    "value": {
      "centerLinePairs": ["T_PV", "ES_TS"],
      "enforceStrictRotation": true
    },
    "isPublic": true
  }
]
```

### 7.3. Initial Translations

Basic UI translations for English and Finnish will be pre-populated, including:
- Shot type names and descriptions
- UI element labels
- Error messages
- Help content

## 8. Performance Considerations

### 8.1. Sharding Strategy
- User data is naturally sharded by `userId`
- For users with large numbers of shots, consider time-based sharding
- Statistics collection pre-aggregates data to avoid expensive queries

### 8.2. Caching Strategy
- Shot types and translations should be cached client-side
- User profile and active session data should be cached for offline use
- Statistics should use a TTL cache for common queries

### 8.3. Denormalization
- Shot type summary data is denormalized into practice sessions for quicker retrieval
- User statistics are denormalized into user documents for profile displays
- This reduces the need for multiple queries when loading common screens

## 9. Data Storage Estimated Requirements

| Collection | Document Size | Expected Growth | Storage Notes |
|------------|--------------|-----------------|---------------|
| users | ~2 KB | Slow | Minimal storage impact |
| shotTypes | ~1 KB | Static | Fixed set, minimal impact |
| practiceSessions | ~5 KB | Medium | Grows with user activity |
| shotResults | ~1 KB | Fast | Main storage driver, grows linearly with usage |
| statistics | ~10 KB | Medium | Pre-calculated, controlled growth |
| settings | ~2 KB | Static | Minimal storage impact |
| translations | ~5 KB | Static | Minimal storage impact |

**Estimated total storage for 1,000 active users (1 year):**
- Average 50 sessions per user = 50,000 sessions
- Average 10 shots per session = 500,000 shot results
- Approximately 1 GB total storage

## 10. Future Expansion Considerations

### 10.1. Team Support
- New `teams` collection to store team metadata
- New `teamMembers` collection for managing team memberships
- Additional fields in user document to track team affiliations

### 10.2. Video Storage
- Integration with Cloud Storage for video files
- New `videos` collection or expanded `shotResults` schema
- Metadata for video processing and analysis

### 10.3. Advanced Analytics
- Additional statistics types for deeper analysis
- Machine learning model data storage
- Recommendation engine data

### 10.4. Social Features
- Friend connections between users
- Shared results and competitions
- Achievement/badge system

---

This database schema is designed to support the CurlingDrawWeightPractice application's current requirements while allowing for future expansion. The schema will evolve as the application develops and as user feedback is incorporated.